# Общая схема взаимодействия сервисов

**Сервис оформления заказов**

- Клиент через приложение выбирает магазин, сэндвич, добавляет его в корзину, применяет акции и указывает самовывоз или доставку. Сервис заказов принимает запрос с данными: ID магазина, ID товара, способ получения (самовывоз/доставка).
- Меню магазина: Отправляет запрос в сервис управления магазинами для получения актуального меню и наличия товара.
- Проверка клиента: Отправляет запрос в сервис аутентификации (например, с JWT-токеном), чтобы подтвердить авторизацию и получить данные клиента (имя, адрес, ID).
- Выбор магазина: Запрашивает у сервиса управления магазинами список ближайших точек по геолокации клиента, фильтруя их по поддержке доставки, если выбрана доставка.
- Применение скидок: Спрашивает у сервиса скидок доступные акции (передает ID клиента и заказа), получает скидку и пересчитывает стоимость.
- Оплата: Передает данные в сервис оплаты (сумма, метод). Если онлайн - ждет подтверждения от платежного шлюза; если курьеру/в магазине - фиксирует выбор.
- Доставка или самовывоз: Для доставки отправляет запрос в сервис доставки (адрес, ID заказа); для самовывоза передает время готовности в сервис уведомлений.
- Время готовности заказа: опрашивает сервис управления магазинами о времени готовности заказа.
- Уведомление клиента: Отправляет в сервис уведомлений команду (например, "Заказ № 123 принят, готов через 20 минут") для push или email.
- Обратная связь: Получает обновления статуса от сервиса оплаты («Оплачено») и доставки («Доставлен») и передает их в уведомления.

**Сервис аутентификации**

- Проверка клиента: Отвечает на запросы сервиса заказов, проверяя токен и возвращая данные клиента (ID, имя, адрес).
- Уведомление клиента: После успешной регистрации или входа отправляет запрос в сервис уведомлений для доставки сообщения.

**Сервис управления магазинами**

Пассивно предоставляет данные по запросам от сервиса заказов (список магазинов, меню, загруженность) и сервиса доставки (адрес магазина для маршрута). Не инициирует запросы самостоятельно.

**Сервис расчета скидок и акций**

- Применение скидок: Отвечает на запросы сервиса заказов, предоставляя доступные акции и бонусы для клиента (на основе его ID и статуса авторизации).
- Уведомление клиентов: Может отправлять запросы в сервис уведомлений для информирования о новых или планируемых акциях.

**Сервис оплаты**

- Обработка оплаты: Принимает запросы от сервиса заказов для инициации оплаты. После успешной онлайн-оплаты отправляет в сервис заказов обновление статуса («Оплачено»). Для оплаты курьеру статус обновляется позже, после подтверждения курьером.
- Уведомление клиента: Направляет запрос в сервис уведомлений для отправки чека или интернет-факса клиенту (например, после доставки или самовывоза).

**Сервис доставки**

- Координация доставки: Принимает запрос от сервиса заказов (адрес, ID заказа и магазина), назначает курьера и строит маршрут.
- Обновление статуса: После завершения доставки отправляет запрос в сервис заказов с подтверждением («Доставлен» или «Не доставлен»).
- Уведомление клиента: Передает в сервис уведомлений статусы (например, «В пути», «Доставлен») через сервис заказов.

**Сервис уведомлений**

Принимает запросы от всех сервисов (заказов, аутентификации, оплаты, скидок, доставки) и отправляет сообщения клиентам (push, email, SMS) или курьерам. Не инициирует запросы самостоятельно.
